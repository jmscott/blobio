#!/bin/bash
#
#  Synopsis:
#	Start/stop bio4d daemon.
#  Usage:
#	bio4d_ctl [stop|start|restart]
#  Exit Status:
#	0	success
#	1	fault
#

PROG=$(basename $0)
PAUSE=3

die()
{
	log "ERROR: $@" >&2
	exit 1
}

log()
{
	_A="$PROG"
	if [ -n "$ACTION" ];  then
		_A="$_A: $ACTION:"
	fi
	echo "$(date +'%Y/%m/%d %H:%M:%S'): $_A: $@"
	
}

ACTION="$1"
case "$BLOBIO_ROOT" in
'')
	die 'not defined: BLOBIO_ROOT environment variable'
	;;
*)
	test ! -d $BLOBIO_ROOT && die "not a directory: $BLOBIO_ROOT"
	log "BLOBIO_ROOT=$BLOBIO_ROOT"
	;;
esac

cd $BLOBIO_ROOT || die "cd $BLOBIO_ROOT failed"

case "$ACTION" in
start)
	sbin/boot-bio4d $BLOBIO_ROOT

	log "pausing $PAUSE seconds while bio4d starts ..."
	sleep $PAUSE
	test -f $PID_PATH || die "no pid file $PID_PATH, so bio4d aborted"
	log "started with pid #$(cat $PID_PATH)"
	log 'tail of log file follows ...'
	tail log/bio4d-$(date +'%a').log
	;;
stop)
	sbin/kill-bio4d
	;;
restart)
	log 'restart'
	(bio4d_ctl stop && bio4d_ctl start) || die 'stop/start failed, bye'
	;;
'')
	die 'missing expected action: start|stop|restart'
	;;
*)
	ACTION=
	die "unknown action: expected start|stop|restart"
	;;
esac
exit 0;
