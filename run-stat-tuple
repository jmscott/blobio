#
#  Synopsis:
#	Summarize stats and duration in run/{flowd,bio4d}.{pid,gyr} files.
#  Description:
#  	Flowd|bio4d processes can be in one of five states:
#
#		UP 	=> running as expected.
#		DOWN	=> is not running but is expected to be online (OK)
#		ZOMBI	=> process is supposed be dead but appears alive
#		YETI	=> process is supposed to be alive but no updates
#		OFFL	=> process is intentionally off line (cleanly)
#
#	The stats accumulated are since boot and the most recent sample.
#	Typically samples are every 10 seconds.  Green/Yellow/Red exist
#	for both the boot and recent samples.
#
#	This script folds the above values into a single, tab-separated tuple.
#	suitable for easy parsing by shell scripts and what-not.
#
#		[bio4d|flowd|flowd>remote]				\
#		[UP|DOWN|ZOMBI|YETI|OFFL]]				\
#		<boot-epoch>						\
#			<boot-green>	<boot-yellow>	<boot-red>	\
#		<recent-epoch>						\
#			<recent-green>	<recent-yellow>	<recent-red>	\
#
#	Here is an example tuple for the flowd process
#
#		flowd\tUP\1630547570\t1080\t0\t01630884910t275\t0\t0
#
#	<green> is the count of correct requests, <yellow> the count
#	of worrisome requests which may impact service and <red> is the
#	count of requests which do impact service.
#
#	See the individual processes for the meaning of green,yellow,red.
#
#		sbin/gyr-flowd-tuple
#		sbin/gyr-bio4-tuple
#
#	For bio4d, <red> sums mundane client errors, timeouts, signals and
#	server-side panics. <green> sums all "ok" replies and "no" replies
#	for "eat" and "get".  <yellow> tallies client side errors (no brr),
#	network timeouts (not file system) and "ok,no" and "ok,ok,no"
#	brr requests.
#
#	For flowd, the stats sum the columns in the *.fdr records.  <green>
#	is the sum of both process (exit code) and query execution (SQLSTATE)
#	status codes.  Typically, <green> counts for a process (*.xdr) or
#	query (*.qdr) are the status tagged as "OK" in the *.flow file.
#	other codes.  The <red> counts are the complement of "OK" counts.
#	A common example of a failed SQL code would "23503" foreign key
#	violation, indicated a bug in the etc/*.flow file. <yellow> counts
#	are always zero.
#
#  Usage:
#	export BLOBIO_ROOT=$HOME/opt/blobio
#	run-stat-tuple | ... sort | ... column
#
#	while sleep 60;  do
#		run-stat | put-to-db
#	done
#  See:
#	run-stat-report
#  Note:
#	Consider a process state OFF for disabled sync remote services,
#	by checking for existence of sync/root/<remote>/etc/sync-<remote>.flow.
#
#	Consider a process state HOST, which means missing run/*.pid but
#	but process appears to be running, since fuser says log/*.log
#	are opened by SOMETHING.
#
#	Really, really, really need to move the files in log/*.{qdr,xdr,fdr}
#	to directory data/ or spool/!
#

STALE_AFTER=61		#  need to derive heartbeat values in etc/profile

die()
{
	echo "$(basename $0): ERROR: $@" >&2
	exit 1
}

test $# = 0 || die "wrong number cli arguments: got $#, expected 0"

test -n "$BLOBIO_ROOT" || die "env not defined: BLOBIO_ROOT"
cd $BLOBIO_ROOT || die "cd $BLOBIO_ROOT: exit status=$?"

_cat_gyr bio4d run
_cat_gyr flowd run

#  check sync flowd process

find sync/root -name run -type d | while read RUN_DIR;  do
	REMOTE=$(basename $(dirname $RUN_DIR))
	_cat_gyr "flowd>$REMOTE" $RUN_DIR
done
