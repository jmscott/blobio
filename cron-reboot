#
#  Synopsis:
#	Cron script to fully reboot all blob process @reboot cron schedule
#  Usage:
#	#  in crontab
#	BLOBIO_ROOT=/usr/local/blobio
#	LOG=$BLOBIO_ROOT/log/cron-reboot.log
#
#	@reboot $BLOBIO_ROOTsbin/cron-reboot >>$LOG 2>&1
#

PROG=$(basename $0)
USER=$(id -un)
FLOWD_PAUSE=3

log()
{
	echo "$(date +'%Y/%m/%d %H:%M:%S'): $PROG#$$: $@"
}

die()
{
	log "ERROR: $@" >&2
	exit 1
}

leave()
{
	log 'good bye, cruel world'
}

log 'hello, world'
trap leave EXIT

test -n "$BLOBIO_ROOT" || die "environment variable not defined: BLOBIO_ROOT"
log "BLOBIO_ROOT=$BLOBIO_ROOT"

cd $BLOBIO_ROOT || die "cd $BLOBIO_ROOT failed"
. etc/profile

zap-proc run/flowd.pid || die "zap-proc flowd failed: exit status=$?"

log 'calling bio4d_ctl reboot ...'
bio4d_ctl reboot
test $? = 0 || die "bio4d_ctl reboot failed: exit status=$STATUS"
log 'bio4d_ctl reboot ok'

log 'starting flowd server in background ...'
flowd server etc/blobio.flow &
log "pausing $FLOWD_PAUSE sec while flowd starts ..."
sleep $FLOWD_PAUSE
test -e run/flowd.pid || die "flowd failed to start in background"
log "flowd pid: $(cat run/flowd.pid)"

log 'reboot sync flowd processes'
reboot-sync || die "reboot-sync failed: exit status=$?"
