#!/bin/bash
#
#  Synospsis:
#	Report of running bio4d & flowd processes.
#  Usage:
#	run-stat-report
#  See:
#	/usr/local/jmscottsbin/run-stat
#	https://github.com/jmscott/work
#  Exit Status:
#	0	ok
#	1	error
#  Note:
#	On gnu/linux sort is ignoring the second key.  The pain never ends.
#
#	Rename this script to run-pid-report?
#
NOW=$(date +'%s')

die()
{
	echo "$(basename $0): ERROR: $@" >&2
	exit 1
}

(
	echo "Process	Status	Duration"
	echo '-------------	------	-----------'
	run-stat							|
		sort --key=2 --key=1 --field-separator=$'\t'		|
		while read PID STATUS START_EPOCH;  do
			DURATION_SEC=$(expr $NOW - $START_EPOCH)
			case "$DURATION_SEC" in
			[0-9]*)
				;;
			-*)
				DURATION_SEC=0
				;;
			'')
				die 'empty process duration'
				;;
			*)
				die "unexpected process duration: $DURATION_SEC"
				;;
			esac
			DURATION=$(duration-english $DURATION_SEC)
			echo "$PID	$STATUS	$DURATION"
		done
		
) | column -s '	' -t | sed 's/ *	//'
