#!/bin/bash
#
#  Synospsis:
#	Report of running bio4d & flowd processes.
#  Usage:
#	run-stat-report
#  See:
#	sbin/run-stat
#	https://github.com/jmscott/work
#  Note:
#	Calculate durations using program jmscott/work/duration-human!
#
#	Sort is ignoring the second key on linux.  The pain never ends.
#
#	Rename this script to run-pid-report?
#
(
	echo "Process	Status	Duration"
	echo '-------------	------	-----------'
	run-stat							|
		sort --key=2 --key=1 --field-separator=$'\t'		|
		awk -F'\t' -v NOW=$(date +'%s') '{
			ELAPSED=NOW - $3;
			DURATION="unknown";
			units = "";
			if ($3 ~ "^[0-9][0-9]*$") {

				#  > 3 days
				if (ELAPSED > 259200) {
					DURATION = ELAPSED / 86400;
					units="day";

				#  > 3 hours

				} else if (ELAPSED > 10800) {
					DURATION = ELAPSED / 3600;
					units="hr";

				#  > 3 minutes

				} else if (ELAPSED > 180) {
					DURATION = ELAPSED / 60;
					units = "min"
				} else {
					DURATION = ELAPSED
					units = "sec";
				}
				DURATION = sprintf("%.0f", DURATION);
			}

			print $1, FS, $2, FS, DURATION, units;
		}'
) | column -s '	' -t | sed 's/ *	//'
